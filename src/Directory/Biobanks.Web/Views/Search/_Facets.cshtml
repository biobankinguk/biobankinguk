@using Biobanks.Web.Models.Search
@using Castle.Core.Internal
@using Newtonsoft.Json
@using Biobanks.Directory.Data.Constants
@model FacetsModel

<div class="col-sm-4">
	@if (!Model.Facets.IsNullOrEmpty())
	{
		var facets = Model.Facets;

		// Hide County Facet
		if (App.Config[ConfigKey.ShowCounties] == "false")
		{
			facets = facets.Where(x => x.Name != "County");
		}

		foreach (var facetGroup in facets.GroupBy(x => x.GroupName))
		{

			// Facet Group Data
			var firstFacet = facetGroup.First();

			var facetGroupNameId = $"FacetGroup{firstFacet.GroupNameWithoutSpaces}";
			var facetGroupIconId = $"FacetGroupIcon{firstFacet.GroupNameWithoutSpaces}";

			var facetGroupCollapsedCookieValue = Request.Cookies[$"{facetGroupNameId}Collapsed"]?.Value;

			var facetGroupCollapsed = facetGroupCollapsedCookieValue != null
				? Convert.ToBoolean(facetGroupCollapsedCookieValue)
				: firstFacet.GroupCollapsedByDefault;

			var groupSelectedCount = facetGroup.Count(
				y => Model.SelectedFacets.Any(sf => y.FacetValues.Select(fv => fv.FacetId).Contains(sf)));


			@* Facet Group Panel *@
			<div class="panel panel-default">
				
				@* Panel Header *@
				<div class="panel-heading facet-group-header" role="button" 
					 data-toggle="collapse" 
					 data-target="#@(facetGroupNameId)"
					 aria-expanded="@((!facetGroupCollapsed).ToString())" 
					 aria-controls="@facetGroupNameId">

					@firstFacet.GroupName

					<span id="@facetGroupIconId" class="facet-group-icon fa @Html.Raw(facetGroupCollapsed ? "fa-plus-square" : "fa-minus-square") pull-right"></span>

					@if (groupSelectedCount > 0)
					{
						<span class="badge facet-group-badge pull-right">@groupSelectedCount in use</span>
					}
				</div>

				@* Panel Body *@
				<div id="@facetGroupNameId" class="panel-body facet-group @(facetGroupCollapsed ? "collapse" : "collapse in")" data-icon-id="@facetGroupIconId">
                    <div class="collapse-panel-body">

                        @* Facets *@
                        @foreach (var facet in facetGroup)
                        {
                            var facetName = "";

                            switch (facet.Name)
                            {
                                case "Macroscopic Assessment":
                                    facetName = App.Config[ConfigKey.MacroscopicAssessmentName]; break;
                                case "Storage Temperature":
                                    facetName = App.Config[ConfigKey.StorageTemperatureName]; break;
                                case "Donor Count":
                                    facetName = App.Config[ConfigKey.DonorCountName]; break;
                                default:
                                    facetName = facet.Name; break;
                            }

                            if (facetName == "County")
                            {
                            <div class="panel panel-default">
                                <div id="countyPanel" class="panel-heading" data-toggle="collapse" data-target="#CountySubPanel" role="button" >
                                    @facetName 
                                    <span id="countySubIconId" class="fa fa-plus-square pull-right"></span>
                                </div>
                                <div id="CountySubPanel" class="facet-group panel-body collapse" data-icon-id="countySubIconId">
                                    <div class="collapse-panel-body">
                                        <ul class="facet-list fa-ul">
                                            @foreach (var facetValue in facet.FacetValues)
                                            {
                                                // Consent Restriction Edgecase
                                                var facetValueName = facetValue.FacetValue;

                                                if (facet.IndexedName == "consentRestrictions" && facetValueName != "No restrictions")
                                                {
                                                    facetValueName = $"No {facetValueName}";
                                                }

                                                if (!Model.FacetSelected(facetValue.FacetId))
                                                {
                                                    <li>
                                                        <a href="@Url.Action(Model.Action, "Search", new
														 {
															 diagnosis = Model.OntologyTerm,
															 selectedFacets = JsonConvert.SerializeObject(Model.SelectedFacets.Concat(new List<string>
															 {
																 facetValue.FacetId
															 }))
														 })">
                                                            <span class="fa fa-circle-o"></span>
                                                            @facetValueName
                                                        </a>
                                                        <span class="facet-count">(@facetValue.Count)</span>
                                                    </li>
                                                }
                                                else
                                                {
                                                    <li>
                                                        <a href="@Url.Action(Model.Action, "Search", new
														 {
															 diagnosis = Model.OntologyTerm,
															 selectedFacets = JsonConvert.SerializeObject(Model.SelectedFacets.Where(
																 x => x != facetValue.FacetId))
														 })">
                                                            <span class="fa fa-check-circle"></span>
                                                            @facetValueName
                                                        </a>
                                                        (@facetValue.Count)
                                                    </li>
                                                }
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        
                            }
                            else
                            {
                            <div class="facet-container">
                                <p class="facet-header">
                                    <strong>@facetName</strong>
                                </p>

                                <ul class="facet-list fa-ul">
                                    @foreach (var facetValue in facet.FacetValues)
                                    {
                                        // Consent Restriction Edgecase
                                        var facetValueName = facetValue.FacetValue;

                                        if (facet.IndexedName == "consentRestrictions" && facetValueName != "No restrictions")
                                        {
                                            facetValueName = $"No {facetValueName}";
                                        }

                                        if (!Model.FacetSelected(facetValue.FacetId))
                                        {
                                            <li>
                                                <a href="@Url.Action(Model.Action, "Search", new
														 {
															 diagnosis = Model.OntologyTerm,
															 selectedFacets = JsonConvert.SerializeObject(Model.SelectedFacets.Concat(new List<string>
															 {
																 facetValue.FacetId
															 }))
														 })">
                                                    <span class="fa fa-circle-o"></span>
                                                    @facetValueName
                                                </a>
                                                <span class="facet-count">(@facetValue.Count)</span>
                                            </li>
                                        }
                                        else
                                        {
                                            <li>
                                                <a href="@Url.Action(Model.Action, "Search", new
														 {
															 diagnosis = Model.OntologyTerm,
															 selectedFacets = JsonConvert.SerializeObject(Model.SelectedFacets.Where(
																 x => x != facetValue.FacetId))
														 })">
                                                    <span class="fa fa-check-circle"></span>
                                                    @facetValueName
                                                </a>
                                                (@facetValue.Count)
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                            }





                            }
                        </div>
				</div>
			</div>
		}
	}
</div>