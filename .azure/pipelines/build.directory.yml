# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
  - master
  
pool:
  vmImage: windows-latest

variables:
  solution: '**/*.sln'
  buildPlatform: Any CPU
  # buildConfiguration: 'Release'  ## Set In DevOps UI

steps:
  # nuget restore
  - task: NuGetToolInstaller@1
    displayName: NuGet - Install Tools
    inputs:
      versionSpec: 5.x
  - task: NuGetCommand@2
    displayName: NuGet - Restore
    inputs:
      restoreSolution: $(solution)

  # publish the web app to a deployable package
  - task: VSBuild@1
    displayName: MSBuild - Publish
    inputs:
      solution: $(solution)
      msbuildArgs: >-
        /p:DeployOnBuild=true
        /p:WebPublishMethod=Package
        /p:_PackageTempDir=C:/Package
        /p:PackageAsSingleFile=true
        /p:PrecompileBeforePublish=true
        /p:SkipInvalidConfigurations=true
        /p:PackageLocation="$(build.StagingDirectory)/webdeploy"
      platform: $(buildPlatform)
      configuration: $(buildConfiguration)

  - publish: $(build.StagingDirectory)/webdeploy
    artifact: webdeploy_package
  
  # publish supporting artifacts used later

  # PublishProfiles
  # Azure doesn't use this, but On-prem will if we can get web deploy working
  # If we can't and have to rebuild, we can use the source instead
  # - publish: $(Build.SourcesDirectory)/Biobanks/Biobanks.Web/Properties/PublishProfiles
  #   artifact: PublishProfiles
  
  # ef6.exe and the Data and Identity assemblies, for migrations
  - task: CopyFiles@2
    displayName: Copy migration files
    inputs:
      SourceFolder: $(Build.SourcesDirectory)/Biobanks
      Contents: |
        packages/**/net45/win-x86/ef6.exe
        Data/bin/**/*.dll
        Identity/bin/**/*.dll
      TargetFolder: $(build.stagingdirectory)/db
      flattenFolders: true
  - publish: $(build.stagingdirectory)/db
    artifact: db_migration
