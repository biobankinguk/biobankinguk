# .NET Core Function App to Windows on Azure
# Build a .NET Core function app
# https://docs.microsoft.com/en-us/azure/devops/pipelines/languages/dotnet-core 

trigger:
  batch: true
  branches:
    include:
    - "*"
  paths:
    include:
    - src/Analytics/*
    - ".azure/pipelines/build.analytics.yml"

pool:
  vmImage: windows-latest

variables:
  vmImageName: 'windows-latest'
  solution: "src/Analytics/*.sln"
  buildPlatform: Any CPU
  # buildConfiguration: 'Release'  ## Set In DevOps UI

steps:
  # nuget restore
  - task: NuGetToolInstaller@1
    displayName: NuGet - Install Tools
    inputs:
      versionSpec: 5.x
  - task: NuGetCommand@2
    displayName: NuGet - Restore
    inputs:
      restoreSolution: $(solution)

  # publish the web app to a deployable package
  - task: VSBuild@1
    displayName: MSBuild - Publish
    inputs:
      solution: $(solution)
      msbuildArgs: >-
        /p:DeployOnBuild=true
        /p:WebPublishMethod=Package
        /p:_PackageTempDir=C:/Package
        /p:PackageAsSingleFile=true
        /p:PrecompileBeforePublish=true
        /p:SkipInvalidConfigurations=true
        /p:PackageLocation="$(build.StagingDirectory)/analyticsdeploy"
      platform: $(buildPlatform)
      configuration: $(buildConfiguration)

  - publish: $(build.StagingDirectory)/analyticsdeploy
    artifact: analytics_deploy_package

  # publish supporting artifacts used later

  # Data assembly for migrations
  - task: CopyFiles@2
    displayName: Copy migration files
    inputs:
      SourceFolder: $(Build.SourcesDirectory)/src/Analytics
      Contents: |
        Analytics/bin/**/*.dll
      TargetFolder: $(build.stagingdirectory)/dbanalytics
      flattenFolders: true
  - publish: $(build.stagingdirectory)/dbanalytics
    artifact: analytics_db_migration
